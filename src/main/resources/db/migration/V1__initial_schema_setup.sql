-- Initial schema setup

--Execute with SYSDBA user
--ALTER DATABASE SET TIME_ZONE = 'Europe/Bucharest';
create user webapp identified by parola01;
grant create session to webapp;

GRANT CREATE TABLE, CREATE VIEW, CREATE PROCEDURE, CREATE SEQUENCE TO webapp;
grant create any context to webapp;
GRANT UNLIMITED TABLESPACE TO webapp;
ALTER USER WEBAPP DEFAULT TABLESPACE USERS;
grant execute on dbms_lock to webapp;

--Execute with WEBAPP user
create or replace package webapp.DATABSE_CONNECTION_CONTEXT is
    procedure set_connection_context (p_username in varchar2);
end;
/
create or replace package body webapp.DATABSE_CONNECTION_CONTEXT is
    procedure set_connection_context (p_username in varchar2) is
    begin
        DBMS_SESSION.set_context(namespace => 'WEBAPP_CTX', attribute => 'USERNAME', value => p_username);
    end set_connection_context;
end;
/

CREATE CONTEXT WEBAPP_CTX USING webapp.DATABSE_CONNECTION_CONTEXT;
grant execute on Dbms_Session to webapp;
grant execute on webapp.DATABSE_CONNECTION_CONTEXT to webapp;

-- Create table
create table WEBAPP.USER_APP
(
    id          NUMBER generated by default on null as identity,
    username    VARCHAR2(255) not null,
    first_name  VARCHAR2(255) not null,
    last_name   VARCHAR2(255) not null,
    inserted_at TIMESTAMP(6) WITH TIME ZONE default SYSTIMESTAMP not null,
    updated_at  TIMESTAMP(6) WITH TIME ZONE,
    version     NUMBER
)
    tablespace USERS
    pctfree 10
    initrans 1
    maxtrans 255;
-- Create/Recreate primary, unique and foreign key constraints
alter table WEBAPP.USER_APP
    add constraint PK_USERS primary key (ID)
        using index
            tablespace USERS
            pctfree 10
            initrans 2
            maxtrans 255;
alter table WEBAPP.USER_APP
    add unique (USERNAME)
        using index
            tablespace USERS
            pctfree 10
            initrans 2
            maxtrans 255;

-- Create table
create table WEBAPP.USER_PROFILES
(
    id           NUMBER generated by default on null as identity,
    id_user      NUMBER not null,
    profile_name VARCHAR2(255) not null,
    inserted_at  TIMESTAMP(6) WITH TIME ZONE default SYSTIMESTAMP not null,
    updated_at   TIMESTAMP(6) WITH TIME ZONE,
    version      NUMBER
)
    tablespace USERS
    pctfree 10
    initrans 1
    maxtrans 255;
-- Create/Recreate indexes
create index WEBAPP.IDX_USER_PROFILES_USER on WEBAPP.USER_PROFILES (ID_USER)
    tablespace USERS
    pctfree 10
    initrans 2
    maxtrans 255;
-- Create/Recreate primary, unique and foreign key constraints
alter table WEBAPP.USER_PROFILES
    add constraint PK_USER_PROFILES primary key (ID)
        using index
            tablespace USERS
            pctfree 10
            initrans 2
            maxtrans 255;
alter table WEBAPP.USER_PROFILES
    add constraint FK_USER_PROFILES_USER foreign key (ID_USER)
        references WEBAPP.USER_APP (ID);

-- Adăugarea unei constrângeri de cheie primară pentru coloana ID
-- Create table
create table WEBAPP.USER_ACTIVE_PROFILES
(
    id           NUMBER generated by default on null as identity,
    id_user      NUMBER not null,
    username     VARCHAR2(255) not null,
    id_profile   NUMBER not null,
    profile_name VARCHAR2(255) not null,
    inserted_at  TIMESTAMP(6) WITH TIME ZONE default SYSTIMESTAMP not null,
    updated_at   TIMESTAMP(6) WITH TIME ZONE,
    version      NUMBER
)
    tablespace USERS
    pctfree 10
    initrans 1
    maxtrans 255;
-- Create/Recreate primary, unique and foreign key constraints
alter table WEBAPP.USER_ACTIVE_PROFILES
    add constraint PK_USER_ACTIVE_PROFILES primary key (ID)
        using index
            tablespace USERS
            pctfree 10
            initrans 2
            maxtrans 255;

-- Create table
create table WEBAPP.USER_ROLES
(
    id           NUMBER generated by default on null as identity,
    id_user      NUMBER not null,
    role_name VARCHAR2(255) not null,
    inserted_at  TIMESTAMP(6) WITH TIME ZONE default SYSTIMESTAMP not null,
    updated_at   TIMESTAMP(6) WITH TIME ZONE,
    version      NUMBER
)
    tablespace USERS
    pctfree 10
    initrans 1
    maxtrans 255;
-- Create/Recreate indexes
create index IDX_USER_ROLES_USER on USER_ROLES (ID_USER)
    tablespace USERS
    pctfree 10
    initrans 2
    maxtrans 255;
-- Create/Recreate primary, unique and foreign key constraints
alter table WEBAPP.USER_ROLES
    add constraint PK_USER_ROLES primary key (ID)
        using index
            tablespace USERS
            pctfree 10
            initrans 2
            maxtrans 255;
alter table WEBAPP.USER_ROLES
    add constraint FK_USER_ROLES_USER foreign key (ID_USER)
        references USER_APP (ID);

grant select, insert, update on webapp.user_app to webapp;
grant select, insert, update on webapp.user_profiles to webapp;
grant select, insert, update on webapp.user_roles to webapp;

CREATE OR REPLACE TRIGGER webapp.trg_user_app_updated_at
    BEFORE UPDATE ON webapp.user_app
    FOR EACH ROW
BEGIN
    :NEW.updated_at := SYSTIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER webapp.trg_user_profiles_updated_at
    BEFORE UPDATE ON webapp.user_profiles
    FOR EACH ROW
BEGIN
    :NEW.updated_at := SYSTIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER webapp.trg_user_roles_updated_at
    BEFORE UPDATE ON webapp.user_roles
    FOR EACH ROW
BEGIN
    :NEW.updated_at := SYSTIMESTAMP;
END;
/
alter table webapp.USER_ACTIVE_PROFILES
    add constraint UQ_UAP_USERNAME unique (USERNAME);

create table webapp.USER_NOTIFICATIONS_NEW
(
    id                      NUMBER generated by default on null as identity,
    id_profile              NUMBER not null,
    module_name             VARCHAR2(255) not null,
    module_aggregate_id     NUMBER not null,
    inserted_at             TIMESTAMP(6) WITH TIME ZONE default SYSTIMESTAMP not null,
    updated_at              TIMESTAMP(6) WITH TIME ZONE,
    version                 NUMBER
)
    tablespace USERS
    pctfree 10
    initrans 1
    maxtrans 255
    storage
(
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
);
-- Create/Recreate primary, unique and foreign key constraints
alter table webapp.USER_NOTIFICATIONS_NEW
    add constraint PK_USER_NOTIFICATIONS_NEW primary key (ID)
        using index
            tablespace USERS
            pctfree 10
            initrans 2
            maxtrans 255
            storage
            (
            initial 64K
            next 1M
            minextents 1
            maxextents unlimited
            );

create index IDX_PROFILE_USER_NOTIFICATIONS_NEW on webapp.USER_NOTIFICATIONS_NEW (id_profile)
    tablespace USERS
    pctfree 10
    initrans 2
    maxtrans 255
    storage
    (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
    );
alter table webapp.USER_NOTIFICATIONS_NEW
    add constraint FK_PROFILE_USER_NOTIFICATIONS_NEW foreign key (id_profile)
        references webapp.USER_PROFILES (ID);

-- Create table
create table WEBAPP.USER_NOTIFICATIONS_OLD
(
    id          NUMBER generated by default on null as identity,
    id_profile  NUMBER not null,
    module_name VARCHAR2(256) not null,
    tip_mesaj   VARCHAR2(256) not null,
    text_mesaj  VARCHAR2(1024) not null,
    inserted_at TIMESTAMP(6) WITH TIME ZONE default SYSTIMESTAMP not null,
    updated_at  TIMESTAMP(6) WITH TIME ZONE
)
    tablespace USERS
    pctfree 10
    initrans 1
    maxtrans 255
    storage
(
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
);
-- Create/Recreate indexes
create index IDX_PROFILE_USER_NOTIFICATIONS_OLD on WEBAPP.USER_NOTIFICATIONS_OLD (ID_PROFILE)
    tablespace USERS
    pctfree 10
    initrans 2
    maxtrans 255
    storage
    (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
    );
-- Create/Recreate primary, unique and foreign key constraints
alter table WEBAPP.USER_NOTIFICATIONS_OLD
    add constraint PK_USER_NOTIFICATIONS_OLD primary key (ID)
        using index
            tablespace USERS
            pctfree 10
            initrans 2
            maxtrans 255
            storage
            (
            initial 64K
            next 1M
            minextents 1
            maxextents unlimited
            );



CREATE OR REPLACE PACKAGE WEBAPP.MESAJE_MODUL_A IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2);
END;
/
CREATE OR REPLACE PACKAGE BODY WEBAPP.MESAJE_MODUL_A IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2) IS
    BEGIN

        delete webapp.user_notifications_old t
        where t.module_name = 'MODUL_A' and
            t.id_profile = p_id_profile;

        --simulam durata verificarilor conditiilor pentru determinarea notificarilor modulului A
        dbms_lock.sleep(3);

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_A', 'DE_AVIZAT', 'Aveti de avizat 5 entitati aferente modulului A!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_A', 'NEAVIZATE', 'Aveti 12 entitati neavizate aferente modulului A!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_A', 'FARA_RASPUNS', 'Aveti 3 entitati la care nu ati raspuns aferente modulului A!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_A', 'BENEFICIAR_PUS', 'Aveti 6 entitati aferente modulului A la care ati fost pus beneficiar si pe care nu le-ati vizualizat!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_A', 'REZOLUTIE_PUSA', 'Aveti 9 entitati afetente modulului A la care au fost puse rezolutii pe care nu le-ati citit!');

    END verificare_mesaje;
END;
/

CREATE OR REPLACE PACKAGE WEBAPP.MESAJE_MODUL_B IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2);
END;
/
CREATE OR REPLACE PACKAGE BODY WEBAPP.MESAJE_MODUL_B IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2) IS
    BEGIN

        delete webapp.user_notifications_old t
        where t.module_name = 'MODUL_B' and
            t.id_profile = p_id_profile;

        --simulam durata verificarilor conditiilor pentru determinarea notificarilor modulului B
        dbms_lock.sleep(6);

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_B', 'NEAVIZATE', 'Aveti 7 entitati neavizate aferente modulului B!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_B', 'FARA_RASPUNS', 'Aveti 10 entitati la care nu ati raspuns aferente modulului B!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_B', 'REZOLUTIE_PUSA', 'Aveti 20 entitati afetente modulului B la care au fost puse rezolutii pe care nu le-ati citit!');

    END verificare_mesaje;
END;
/

CREATE OR REPLACE PACKAGE WEBAPP.MESAJE_MODUL_C IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2);
END;
/
CREATE OR REPLACE PACKAGE BODY WEBAPP.MESAJE_MODUL_C IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2) IS
    BEGIN

        delete webapp.user_notifications_old t
        where t.module_name = 'MODUL_C' and
            t.id_profile = p_id_profile;

        --simulam durata verificarilor conditiilor pentru determinarea notificarilor modulului C
        dbms_lock.sleep(2);

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_C', 'DE_AVIZAT', 'Aveti de avizat 3 entitati aferente modulului C!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_C', 'NEAVIZATE', 'Aveti 16 entitati neavizate aferente modulului C!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_C', 'BENEFICIAR_PUS', 'Aveti 96 entitati aferente modulului C la care ati fost pus beneficiar si pe care nu le-ati vizualizat!');


    END verificare_mesaje;
END;
/

CREATE OR REPLACE PACKAGE WEBAPP.MESAJE_MODUL_D IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2);
END;
/
CREATE OR REPLACE PACKAGE BODY WEBAPP.MESAJE_MODUL_D IS
    PROCEDURE verificare_mesaje (p_id_profile IN VARCHAR2) IS
    BEGIN

        delete webapp.user_notifications_old t
        where t.module_name = 'MODUL_D' and
            t.id_profile = p_id_profile;

        --simulam durata verificarilor conditiilor pentru determinarea notificarilor modulului A
        dbms_lock.sleep(8);

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_D', 'DE_AVIZAT', 'Aveti de avizat 9 entitati aferente modulului D!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_D', 'NEAVIZATE', 'Aveti 2 entitati neavizate aferente modulului D!');

        insert into webapp.user_notifications_old(id_profile,module_name,tip_mesaj,text_mesaj)
        values (p_id_profile, 'MODUL_D', 'BENEFICIAR_PUS', 'Aveti 9845 entitati aferente modulului D la care ati fost pus beneficiar si pe care nu le-ati vizualizat!');


    END verificare_mesaje;
END;
/

insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-A',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-A',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-A',3);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-A',4);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-A',5);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-A',6);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-A',7);


insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',3);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',4);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',5);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',6);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',7);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',8);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-B',9);

insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-C',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-C',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-C',3);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-C',4);

insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',3);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',4);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',5);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',6);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',7);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',8);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',9);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',10);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',11);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-D',12);

insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-E',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-E',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-E',3);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-E',4);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-E',5);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-E',6);

insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',3);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',4);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',5);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',6);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',7);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',8);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',9);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',10);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',11);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',12);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',13);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-F',14);

insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',3);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',4);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',5);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',6);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',7);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-G',8);

insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-H',1);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-H',2);
insert into webapp.user_notifications_new(id_profile,module_name,module_aggregate_id) values (1,'MODUL-H',3);